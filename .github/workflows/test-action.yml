name: Test Action

on:
  push:
    branches:
      - main
    paths:
      - 'action.yml'
      - '.github/workflows/test-action.yml'
  workflow_dispatch:

jobs:
  test-setup:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux: Single User (Default), No Channel
          - os: ubuntu-latest
            multi_user: 'false'
            channel: ''
            name: Linux Single-User No-Channel

          # Linux: Single User, With Channel
          - os: ubuntu-latest
            multi_user: 'false'
            channel: 'https://nixos.org/channels/nixpkgs-unstable nixpkgs'
            name: Linux Single-User Channel

          # Linux: Multi User
          - os: ubuntu-latest
            multi_user: 'true'
            channel: 'https://nixos.org/channels/nixpkgs-unstable nixpkgs'
            name: Linux Multi-User

          # Linux ARM: Single User
          - os: ubuntu-24.04-arm
            multi_user: 'false'
            channel: 'https://nixos.org/channels/nixpkgs-unstable nixpkgs'
            name: Linux ARM Single-User

          # macOS: Latest (ARM), No Channel
          - os: macos-latest
            multi_user: 'false' # Should be ignored/forced to true
            channel: ''
            name: macOS ARM No-Channel

          # macOS: Intel, With Channel
          - os: macos-15-intel
            multi_user: 'true'
            channel: 'https://nixos.org/channels/nixpkgs-unstable nixpkgs'
            name: macOS Intel Channel

          # Linux: Extra Config
          - os: ubuntu-latest
            multi_user: 'false'
            channel: 'https://nixos.org/channels/nixpkgs-unstable nixpkgs'
            extra_nix_config: 'experimental-features = nix-command flakes'
            name: Linux Extra Config

    runs-on: ${{ matrix.os }}
    name: ${{ matrix.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Nix
        uses: ./
        with:
          repository: shaogme/speedy-nix
          channel: ${{ matrix.channel }}
          multi_user: ${{ matrix.multi_user }}
          extra_nix_config: ${{ matrix.extra_nix_config }}

      - name: Verify Installation
        shell: bash
        run: |
          echo "Verifying Nix installation..."
          nix --version
          
          if [[ -n "${{ matrix.channel }}" ]]; then
            echo "Testing nix-shell (Channel provided)..."
            nix-shell -p hello --run hello
          else
            echo "Testing basic evaluation (No channel)..."
            nix-instantiate --eval -E '1+1'
          fi
          
          # Verify Multi-user/Daemon presence in PATH
          if [[ "${{ matrix.multi_user }}" == "true" ]] || [[ "$RUNNER_OS" == "macOS" ]]; then
             echo "Checking for multi-user daemon paths..."
             if [[ ":$PATH:" != *":/nix/var/nix/profiles/default/bin:"* ]]; then
                 echo "::warning::Daemon path /nix/var/nix/profiles/default/bin not found in PATH"
             else
                 echo "Daemon path confirmed."
             fi
          else
             echo "Checking for single-user paths..."
             if [[ ":$PATH:" != *":$HOME/.nix-profile/bin:"* ]]; then
                 echo "::warning::Single-user path $HOME/.nix-profile/bin not found in PATH"
             else
                 echo "Single-user path confirmed."
             fi
          fi

          # Verify extra_nix_config if set
          if [[ -n "${{ matrix.extra_nix_config }}" ]]; then
             echo "Verifying extra_nix_config..."
             if [[ "${{ matrix.multi_user }}" == "true" ]]; then
                CONFIG_FILE="/etc/nix/nix.conf"
             else
                CONFIG_FILE="$HOME/.config/nix/nix.conf"
             fi
             
             if grep -q "experimental-features = nix-command flakes" "$CONFIG_FILE"; then
                echo "Configuration applied successfully."
             else
                echo "::error::Configuration not found in $CONFIG_FILE"
                cat "$CONFIG_FILE"
                exit 1
             fi
          fi
