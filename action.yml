name: 'Speedy Nix Setup'
description: 'Fastest way to install Nix from speedy-nix mirror'
author: 'shaogme'
branding:
  icon: 'zap'
  color: 'blue'
inputs:
  repository:
    description: 'Repository to download artifacts from'
    required: false
    default: 'shaogme/speedy-nix'
  channel:
    description: 'Nix channel to add (e.g. https://nixos.org/channels/nixpkgs-unstable nixpkgs)'
    required: false
    default: ''
  multi_user:
    description: 'Perform a multi-user installation (Linux only, macOS is always multi-user)'
    required: false
    default: 'false'
  extra_nix_config:
    description: 'Extra configuration to append to nix.conf'
    required: false
    default: ''

runs:
  using: "composite"
  steps:
    - name: Download and Install Nix
      shell: bash
      env:
        INPUT_REPO: ${{ inputs.repository }}
        INPUT_CHANNEL: ${{ inputs.channel }}
        INPUT_MULTI_USER: ${{ inputs.multi_user }}
        INPUT_EXTRA_NIX_CONFIG: ${{ inputs.extra_nix_config }}

      run: |
        set -e
        
        # Detect OS and Arch
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          OS_KEY="linux"
        elif [[ "$RUNNER_OS" == "macOS" ]]; then
          OS_KEY="darwin"
        else
          echo "::error::Unsupported OS: $RUNNER_OS"
          exit 1
        fi
        
        ARCH=$(uname -m)
        if [[ "$ARCH" == "x86_64" ]]; then
          ARCH_KEY="x86_64"
        elif [[ "$ARCH" == "aarch64" ]] || [[ "$ARCH" == "arm64" ]]; then
          ARCH_KEY="aarch64"
        else
          echo "::error::Unsupported Architecture: $ARCH"
          exit 1
        fi
        
        SYSTEM="${ARCH_KEY}-${OS_KEY}"
        
        INSTALL_DIR="${{ runner.temp }}/speedy-nix/latest"
        mkdir -p "$INSTALL_DIR"
        
        # Construct URL for latest release
        FILENAME="nix-${SYSTEM}.tar.zst"
        URL="https://github.com/${INPUT_REPO}/releases/latest/download/${FILENAME}"
        
        echo "Downloading Nix (latest) for ${SYSTEM} from: $URL"
        
        # Stream download and extract
        curl -fL "$URL" | zstd -d --stdout | tar -x -C "$INSTALL_DIR" || {
           echo "::error::Failed to download or extract Nix. URL: $URL"
           exit 1
        }
        
        # Find extraction root
        EXTRACTED_ROOT=$(find "$INSTALL_DIR" -maxdepth 1 -name "nix-*-${SYSTEM}" -type d | head -n 1)
        
        if [[ -z "$EXTRACTED_ROOT" ]]; then
           echo "::error::Could not find extracted directory in $INSTALL_DIR"
           ls -la "$INSTALL_DIR"
           exit 1
        fi
        
        echo "Installing Nix..."
        
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          if [[ "$INPUT_MULTI_USER" == "true" ]]; then
             # Linux: Multi-user install
             echo "Performing multi-user installation on Linux..."
             if ! sudo "$EXTRACTED_ROOT/install" --daemon --no-channel-add --yes; then
                echo "::error::Multi-user installation failed."
                exit 1
             fi
             
             NIX_PROFILE_SCRIPT="/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh"
             NIX_BIN_PATH="/nix/var/nix/profiles/default/bin:$HOME/.nix-profile/bin"
          else
             # Linux: Single-user install
             echo "Performing single-user installation on Linux..."
             "$EXTRACTED_ROOT/install" --no-daemon --no-channel-add --yes
             
             NIX_PROFILE_SCRIPT="$HOME/.nix-profile/etc/profile.d/nix.sh"
             NIX_BIN_PATH="$HOME/.nix-profile/bin"
          fi
        elif [[ "$RUNNER_OS" == "macOS" ]]; then
          # macOS: Multi-user/Daemon install (required by modern Nix on macOS)
          echo "Performing multi-user installation on macOS (required)..."
          sudo "$EXTRACTED_ROOT/install" --daemon --no-channel-add --yes
          
          NIX_PROFILE_SCRIPT="/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh"
          # We add both default (system) and user profile bin to PATH
          NIX_BIN_PATH="/nix/var/nix/profiles/default/bin:$HOME/.nix-profile/bin"
        fi
        
        # Setup environment
        echo "Setting up environment..."
        if [ -e "$NIX_PROFILE_SCRIPT" ]; then 
            . "$NIX_PROFILE_SCRIPT"
            
            # Export PATH to GITHUB_PATH
            # Split paths by : and add each to GITHUB_PATH
            IFS=':' read -ra PATHS <<< "$NIX_BIN_PATH"
            for p in "${PATHS[@]}"; do
                echo "$p" >> $GITHUB_PATH
            done
            
            # Apply extra_nix_config
            if [ -n "$INPUT_EXTRA_NIX_CONFIG" ]; then
                 echo "Applying extra_nix_config..."
                 if [[ "$RUNNER_OS" == "Linux" && "$INPUT_MULTI_USER" != "true" ]]; then
                     # Single user linux
                     mkdir -p ~/.config/nix
                     echo "$INPUT_EXTRA_NIX_CONFIG" >> ~/.config/nix/nix.conf
                 else
                     # Multi-user (Linux or macOS)
                     echo "$INPUT_EXTRA_NIX_CONFIG" | sudo tee -a /etc/nix/nix.conf > /dev/null
                 fi
            fi
            
            # Add channel if specified
            if [ -n "$INPUT_CHANNEL" ]; then
                echo "Adding Nix channel: $INPUT_CHANNEL"
                nix-channel --add $INPUT_CHANNEL
                nix-channel --update
            fi

            # Verify
            nix --version
        else
            echo "::error::Nix installed but profile script not found at $NIX_PROFILE_SCRIPT"
            exit 1
        fi
